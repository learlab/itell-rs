name: Update Content

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: "Branch to update (comma-separated for multiple branches)"
        required: true
        default: "main,rmp"
      volume_id:
        description: "Volume ID to fetch"
        required: true
        default: "nhm9t3owr7ze7ij01uduaiop"
      content_path:
        description: "Path to content directory"
        required: true
        default: "apps/demo/content/textbook"
      commit_message:
        description: "Commit message"
        required: true
        default: "Auto update content from fetch_volume"
  schedule:
    - cron: "0 0 * * *" # Run daily at midnight UTC

env:
  VOLUME_ID: ${{ github.event.inputs.volume_id || 'nhm9t3owr7ze7ij01uduaiop' }}
  CONTENT_PATH:
    ${{ github.event.inputs.content_path || 'apps/demo/content/textbook' }}
  COMMIT_MESSAGE:
    ${{ github.event.inputs.commit_message || 'Auto update content from
    fetch_volume' }}
  TARGET_BRANCHES: ${{ github.event.inputs.target_branch || 'main,rmp' }}
  REPO_NAME: "learlab/itell"

jobs:
  fetch-volume:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable

      - uses: Swatinem/rust-cache@v2

      - name: Build
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --release --bin fetch_volume

      - name: Run fetch_volume
        run: ./target/release/fetch_volume ${{ env.VOLUME_ID }} output

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.REPO_NAME }}
          path: "target_repo"
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0 # Fetch all history for all branches

      - name: Copy generated content
        run: |
          cp -R ./output/* ./target_repo/${{ env.CONTENT_PATH }}/

      - name: Configure Git
        run: |
          cd target_repo
          git config user.name github-actions
          git config user.email github-actions@github.com

      - name: Update branches
        run: |
          cd target_repo
          # Convert comma-separated branch list to array
          IFS=',' read -ra BRANCHES <<< "${{ env.TARGET_BRANCHES }}"

          for BRANCH in "${BRANCHES[@]}"; do
            # Trim whitespace
            BRANCH=$(echo $BRANCH | xargs)
            echo "Processing branch: $BRANCH"
            
            # Fetch all branches
            git fetch origin
            
            # Check if branch exists remotely
            if git ls-remote --heads origin $BRANCH | grep -q $BRANCH; then
              # Branch exists, check it out
              git checkout $BRANCH || git checkout -b $BRANCH origin/$BRANCH
              git pull origin $BRANCH
            else
              # Branch doesn't exist, create it
              git checkout -b $BRANCH
            fi
            
            # Ensure content directory exists
            mkdir -p ${{ env.CONTENT_PATH }}
            
            # Copy content
            cp -R ../output/* ./${{ env.CONTENT_PATH }}/
            
            # Stage changes
            git add .
            
            # Commit and push changes
            if git status --porcelain | grep .; then
              git commit -m "${{ env.COMMIT_MESSAGE }}"
              git push origin $BRANCH
            else
              echo "No changes to commit for $BRANCH"
            fi
          done
